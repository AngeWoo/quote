<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>真如24拔苦代受靈訓</title>
    <style>
        /* 原有 CSS 保持不變 */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            padding: 1rem;
            position: relative;
            overflow-x: hidden;
        }
        /* ... 其餘樣式省略，保持原樣 ... */
    </style>
</head>
<body>
    <div class="container">
        <h1>✨ 真如24拔苦代受靈訓 ✨</h1>
        <div class="quote-display" id="quoteDisplay">
            <div class="loading" id="loadingIndicator">
                <div class="loading-spinner"></div>
                <span>正在載入智慧法語...</span>
            </div>
            <div class="quote-text" id="quoteText" style="display: none;">
                點擊「隨機名句」開始您的智慧之旅
            </div>
            <span class="quote-number" id="quoteNumber" style="display: none;"></span>
            <div class="error-message" id="errorMessage" style="display: none;"></div>
        </div>
        <div class="controls">
            <button class="btn btn-random" id="randomBtn" onclick="getRandomQuote()" disabled>
                <span class="btn-text">🎲 隨機名句</span>
            </button>
            <div class="nav-controls">
                <button class="btn" id="prevBtn" onclick="getPrevQuote()" disabled>
                    <span class="btn-text">⬅️ 上一句</span>
                </button>
                <button class="btn" id="nextBtn" onclick="getNextQuote()" disabled>
                    <span class="btn-text">➡️ 下一句</span>
                </button>
            </div>
        </div>

    <script>
        // 使用 Google Sheets 公開 HTML，透過 AllOrigins 代理以解決 CORS
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTQp08ZcC5kK1DRs8jE0FYXwmFLh5wXTxJZgdjuOK8s_UIcovZaqKqJhRIAa-Qz3yh5O80cs55euiKp/pubhtml';
        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(sheetUrl)}`;

        let quotes = [];
        let currentIndex = 0;

        // UI 元素
        const elements = {
            quoteText: document.getElementById('quoteText'),
            quoteNumber: document.getElementById('quoteNumber'),
            quoteDisplay: document.getElementById('quoteDisplay'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            errorMessage: document.getElementById('errorMessage'),
            randomBtn: document.getElementById('randomBtn'),
            nextBtn: document.getElementById('nextBtn'),
            prevBtn: document.getElementById('prevBtn')
        };

        // 初始化應用程式
        function initializeApp() {
            // 隱藏載入畫面並顯示內容及按鈕
            elements.loadingIndicator.style.display = 'none';
            elements.quoteText.style.display = 'block';
            elements.quoteNumber.style.display = 'inline-block';
            elements.randomBtn.disabled = false;
            elements.nextBtn.disabled = false;
            elements.prevBtn.disabled = false;
            displayQuote(0);
            console.log(`已載入 ${quotes.length} 句真如名言`);
        }

        // 顯示名句
        function displayQuote(index) {
            if (quotes.length === 0) return;
            elements.quoteDisplay.classList.remove('fade-in');
            elements.quoteDisplay.style.opacity = '0.7';
            elements.quoteDisplay.style.transform = 'scale(0.98)';
            setTimeout(() => {
                elements.quoteText.textContent = quotes[index];
                elements.quoteNumber.textContent = `第 ${index + 1} 句 / 共 ${quotes.length} 句`;
                elements.quoteDisplay.classList.add('fade-in');
                elements.quoteDisplay.style.opacity = '1';
                elements.quoteDisplay.style.transform = 'scale(1)';
            }, 150);
            currentIndex = index;
        }

        // 隨機、下一句、上一句 函式
        function getRandomQuote() {
            if (quotes.length === 0) return;
            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * quotes.length);
            } while (randomIndex === currentIndex && quotes.length > 1);
            displayQuote(randomIndex);
        }
        function getNextQuote() {
            if (quotes.length === 0) return;
            displayQuote((currentIndex + 1) % quotes.length);
        }
        function getPrevQuote() {
            if (quotes.length === 0) return;
            displayQuote(currentIndex === 0 ? quotes.length - 1 : currentIndex - 1);
        }

        // 鍵盤快捷鍵
        document.addEventListener('keydown', e => {
            if (['ArrowRight',' '].includes(e.key)) { e.preventDefault(); getNextQuote(); }
            else if (e.key === 'ArrowLeft') { e.preventDefault(); getPrevQuote(); }
            else if (['r','R'].includes(e.key)) { e.preventDefault(); getRandomQuote(); }
        });

        // 觸控滑動支持
        let startX = 0, startY = 0;
        elements.quoteDisplay.addEventListener('touchstart', e => {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        });
        elements.quoteDisplay.addEventListener('touchend', e => {
            const endX = e.changedTouches[0].clientX;
            const endY = e.changedTouches[0].clientY;
            const diffX = startX - endX;
            const diffY = startY - endY;
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                diffX > 0 ? getNextQuote() : getPrevQuote();
            }
            startX = 0; startY = 0;
        });

        // 從 Google Sheets 載入名句
        async function fetchQuotes() {
            elements.loadingIndicator.style.display = 'flex';
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`網路錯誤 (狀態碼: ${response.status})`);
                const htmlText = await response.text();
                const doc = new DOMParser().parseFromString(htmlText, 'text/html');
                const rows = doc.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cell = row.querySelector('td:nth-child(2)');
                    if (cell) quotes.push(cell.textContent.trim());
                });
                if (quotes.length === 0) throw new Error('未從 Google Sheets 讀取到任何名句');
                initializeApp();
            } catch (error) {
                elements.loadingIndicator.style.display = 'none';
                elements.errorMessage.style.display = 'block';
                elements.errorMessage.textContent = `讀取資料時發生錯誤: ${error.message}`;
            }
        }

        window.onload = fetchQuotes;
    </script>
</body>
</html>
